version: 0.2

env:
  variables:
    GIT_CLONE_DEPTH: 0

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing phase..."
      - echo "Node $(node --version), npm $(npm --version)"

  pre_build:
    commands:
      - echo "Starting API Build Phase..."
      - echo "Installing dependencies for API..."
      - cd packages/api
      - npm install --include=dev --legacy-peer-deps
      - echo "Dependencies installed"
      - echo "Verifying TypeScript installation..."
      - test -f node_modules/.bin/tsc && echo "tsc found" || (echo "ERROR - tsc not found" && exit 1)
      - echo "Verifying Prisma installation..."
      - test -f node_modules/.bin/prisma && echo "prisma found" || (echo "ERROR - prisma not found" && exit 1)
      - echo "Generating Prisma client..."
      - |
        export PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1
        npx prisma generate || (echo "Retrying Prisma generate..." && sleep 5 && npx prisma generate)
      - echo "Prisma client generated"

  build:
    commands:
      - echo "Building API Application..."
      - echo "Running TypeScript compiler..."
      - npx tsc
      - echo "TypeScript compilation completed"
      - echo "Verifying dist folder was created..."
      - pwd
      - ls -la
      - test -d dist || (echo "ERROR - dist/ folder not created" && exit 1)
      - echo "dist/ folder exists"
      - echo "Listing dist contents..."
      - ls -la dist/
      - find dist -type f | head -20
      - echo "API build completed successfully"

  post_build:
    commands:
      - echo "Post-build phase for API..."
      - echo "Build completed"

artifacts:
  files:
    - '**/*'
  base-directory: 'packages/api/dist'
  name: api-build-artifact

cache:
  paths:
    - 'packages/api/node_modules/**/*'
