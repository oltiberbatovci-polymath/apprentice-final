version: 0.2

env:
  variables:
    GIT_CLONE_DEPTH: 0

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Node $(node --version), NPM $(npm --version)"
      - git fetch --unshallow || true
      - git submodule update --init --recursive || true

  pre_build:
    commands:
      - echo "Starting Web Build..."
      - test -d packages/web && echo "packages/web FOUND" || (echo "MISSING" && exit 1)
      - npm install --prefix packages/web --legacy-peer-deps

  build:
    commands:
      - echo "Compiling TS..."
      - ./packages/web/node_modules/.bin/tsc --project packages/web
      - echo "Running Vite build..."
      - ./packages/web/node_modules/.bin/vite build
      - echo "Build output:"
      - ls -la packages/web/dist/

  post_build:
    commands:
      - echo "Web build completed"

artifacts:
  files:
    - '**/*'
  base-directory: 'packages/web/dist'
  name: web-build-artifact-$(date +%Y%m%d-%H%M%S)

cache:
  paths:
    - 'packages/web/node_modules/**/*'